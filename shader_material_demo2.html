<!DOCTYPE html>
<html>
<head>
    <title>ShaderMaterial</title>
	<script src="js/three.js"></script>
	<script src="js/controls/OrbitControls.js"></script>
	<script src="js/libs/stats.min.js"></script>
	<script src="js/libs/dat.gui.min.js"></script>
	<script src="jquery/jquery-3.3.1.min.js"></script>
    <style>
        body {
            /* 设置 margin 为 0，并且 overflow 为 hidden，来完成页面样式 */
            margin: 0;
            overflow: hidden;
        }
		/* 统计对象的样式 */
		#Stats-output {
			position: absolute;
			left: 0px;
			top: 0px;
		}
    </style>
</head>
<body>
 
<!-- 用于 WebGL 输出的 Div -->
<div id="webgl-output"></div>
<!-- 用于统计 FPS 输出的 Div -->
<div id="stats-output"></div>
 
<script id="vertex-shader" type="x-shader/x-vertex">
    #define PHONG
	varying vec3 vViewPosition;
	#ifndef FLAT_SHADED
		varying vec3 vNormal;
	#endif
	#include <common>
	#ifdef USE_UV_MATRIX
	#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )
		varying vec2 vUv;
		uniform mat3 uvMatrix;
	#endif
	#else
	#include <uv_pars_vertex>
	#endif
	#include <uv2_pars_vertex>
	#include <displacementmap_pars_vertex>
	#include <envmap_pars_vertex>
	#include <color_pars_vertex>
	#include <fog_pars_vertex>
	#include <morphtarget_pars_vertex>
	#include <skinning_pars_vertex>
	#include <shadowmap_pars_vertex>
	#include <logdepthbuf_pars_vertex>
	#include <clipping_planes_pars_vertex>
	uniform vec3 vertexConstant;
	uniform vec2 vertexParameters;
	vec3 transformPosition(in vec3 maxLevelPosition) {
	    float vertexGridSize = vertexParameters.x;
	    float powPrecision = vertexParameters.y;
	    vec3 gridPosition = (maxLevelPosition - vertexConstant) / vertexGridSize;
	    return floor(gridPosition / powPrecision) * powPrecision * vertexGridSize + vertexConstant;
	}
	void main() {
	    vec3 position = transformPosition(position);
	#ifdef USE_UV_MATRIX
	#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )
	    vUv = ( uvMatrix * vec3( uv, 1 ) ).xy;
	#endif
	#else
	    #include <uv_vertex>
	#endif
		#include <uv2_vertex>
		#include <color_vertex>
		#include <beginnormal_vertex>
		#include <morphnormal_vertex>
		#include <skinbase_vertex>
		#include <skinnormal_vertex>
		#include <defaultnormal_vertex>
	#ifndef FLAT_SHADED
		vNormal = normalize( transformedNormal );
	#endif
		#include <begin_vertex>
		#include <displacementmap_vertex>
		#include <morphtarget_vertex>
		#include <skinning_vertex>
		#include <project_vertex>
		#include <logdepthbuf_vertex>
		#include <clipping_planes_vertex>
		vViewPosition = - mvPosition.xyz;
		#include <worldpos_vertex>
		#include <envmap_vertex>
		#include <shadowmap_vertex>
		#include <fog_vertex>
	}
</script>
 
<script id="fragment-shader-1" type="x-shader/x-fragment">
	#define PHONG
	uniform vec3 diffuse;
	uniform vec3 emissive;
	uniform vec3 specular;
	uniform float shininess;
	uniform float opacity;
	#include <common>
	#include <packing>
	#include <color_pars_fragment>
	#include <uv_pars_fragment>
	#include <uv2_pars_fragment>
	#include <map_pars_fragment>
	#include <alphamap_pars_fragment>
	#include <aomap_pars_fragment>
	#include <lightmap_pars_fragment>
	#include <emissivemap_pars_fragment>
	#include <envmap_pars_fragment>
	#include <gradientmap_pars_fragment>
	#include <fog_pars_fragment>
	#include <bsdfs>
	#include <lights_pars_begin>
	#include <lights_phong_pars_fragment>
	#include <shadowmap_pars_fragment>
	#include <bumpmap_pars_fragment>
	#include <normalmap_pars_fragment>
	#include <specularmap_pars_fragment>
	#include <logdepthbuf_pars_fragment>
	#include <clipping_planes_pars_fragment>
	void main() {
		#include <clipping_planes_fragment>
		vec4 diffuseColor = vec4( diffuse, opacity );
		ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );
		vec3 totalEmissiveRadiance = emissive;
		#include <logdepthbuf_fragment>
		#include <map_fragment>
		#include <color_fragment>
		#include <alphamap_fragment>
		#include <alphatest_fragment>
		#include <specularmap_fragment>
		#include <normal_flip>
		#include <normal_fragment>
		#include <emissivemap_fragment>
		#include <lights_phong_fragment>
		#include <lights_template>
		#include <aomap_fragment>
		vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;
		#include <envmap_fragment>
	    gl_FragColor = vec4( outgoingLight, diffuseColor.a );
		#include <premultiplied_alpha_fragment>
		#include <tonemapping_fragment>
		#include <encodings_fragment>
		#include <fog_fragment>
	}
</script>
 
<!-- 运行 Three.js 示例的 Javascript 代码 -->
<script type="text/javascript">
 
	var scene;
	var camera;
	var render;
	var webglRender;
	var canvasRender;
	var controls;
	var stats;
	var guiParams;
	
	var ground;
	var cube;
	
	var meshMaterial;
	
	var ambientLight;

	var shaderMaterial;
 
    $(function() {
		stats = initStats();
		scene = new THREE.Scene();
		
		webglRender = new THREE.WebGLRenderer( {antialias: true, alpha: true} ); // antialias 抗锯齿
		webglRender.setSize(window.innerWidth, window.innerHeight);
		// webglRender.setClearColor(0x000000, 1.0);
		// webglRender.shadowMap.enabled = true; // 允许阴影投射
		render = webglRender;
		
		camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 10, 10000); // 2147483647
		camera.position.set(0, -1000, 0);
		
		var target = new THREE.Vector3(0, 0 , 0);
		controls = new THREE.OrbitControls(camera, render.domElement);
		controls.target = target;
		camera.lookAt(target);
		
		$('#webgl-output')[0].appendChild(render.domElement);
		window.addEventListener('resize', onWindowResize, false);
		
		// ambientLight = new THREE.AmbientLight(0x0c0c0c);
		// scene.add(ambientLight);
		
		// 定义几何体
        // var cubeGeometry = new THREE.BoxGeometry(20, 20, 20);
        var geometry = new THREE.BufferGeometry();
        var textures = new Float32Array([0.9729999899864197,0.13050000369548798,0.9729999899864197,0.9695000052452087,0.026499999687075615,0.9695000052452087,0.026499999687075615,0.9695000052452087,0.026499999687075615,0.13050000369548798,0.9729999899864197,0.13050000369548798,0.026499999687075615,0.9695000052452087,0.026499999687075615,0.12049999833106995,0.9729999899864197,0.12049999833106995,0.9729999899864197,0.12049999833106995,0.9729999899864197,0.9695000052452087,0.026499999687075615,0.9695000052452087,0.026499999687075615,0.9994999766349792,0.026499999687075615,0.0005000000237487257,0.9729999899864197,0.0005000000237487257,0.9729999899864197,0.0005000000237487257,0.9729999899864197,0.9994999766349792,0.026499999687075615,0.9994999766349792,0.9664999842643738,0.22349999845027924,0.9664999842643738,0.8345000147819519,0.042500000447034836,0.8345000147819519,0.042500000447034836,0.8345000147819519,0.042500000447034836,0.22349999845027924,0.9664999842643738,0.22349999845027924,1.0175000429153442,0.15800000727176666,1.0175000429153442,0.8379999995231628,-0.017500000074505806,1,1.0069999694824219,0,-0.017500000074505806,1,-0.017500000074505806,0,-0.007000000216066837,0,1.0175000429153442,0,1.0175000429153442,1,1.0175000429153442,1,-0.017500000074505806,0.8379999995231628,-0.017500000074505806,0.15800000727176666,0.9664999842643738,0.8345000147819519,0.9664999842643738,0.9800000190734863,0.042500000447034836,0.9800000190734863,0.042500000447034836,0.9800000190734863,0.042500000447034836,0.8345000147819519,0.9664999842643738,0.8345000147819519,1.0175000429153442,0.8379999995231628,0.9950000047683716,1,-0.017500000074505806,1,1.0175000429153442,1,0.004999999888241291,1,-0.017500000074505806,0.8379999995231628,0.9664999842643738,0.08150000125169754,0.9664999842643738,0.22349999845027924,0.042500000447034836,0.22349999845027924,0.042500000447034836,0.22349999845027924,0.042500000447034836,0.08150000125169754,0.9664999842643738,0.08150000125169754,1.0069999694824219,0,1.0175000429153442,0.15800000727176666,-0.017500000074505806,1,-0.007000000216066837,0,1.0175000429153442,1,-0.017500000074505806,0.15800000727176666]);
        var normals = new Float32Array([0.9990000128746033,-0.9959999918937683,2.0880000591278076,4,1.9989999532699585,0.9990000128746033,-3.999000072479248,1,2,-3.999000072479248,1,2,-1,-1.9919999837875366,1.1759999990463257,0.9990000128746033,-0.9959999918937683,2.0880000591278076,1,0.9990000128746033,-2,1.9989999532699585,-1.9980000257492065,-1.0839999914169312,-2,-0.9990000128746033,-2.0420000553131104,-2,-0.9990000128746033,-2.0420000553131104,-0.9990000128746033,2,-0.9990000128746033,1,0.9990000128746033,-2,4,1.9989999532699585,0.9990000128746033,1,0.9990000128746033,-2,-0.9990000128746033,2,-0.9990000128746033,-0.9990000128746033,2,-0.9990000128746033,-3.999000072479248,1,2,4,1.9989999532699585,0.9990000128746033,1.9989999532699585,-2.999000072479248,-0.041999999433755875,1.9989999532699585,-2.992000102996826,0.17599999904632568,-2,-2.996000051498413,0.08799999952316284,-2,-2.996000051498413,0.08799999952316284,-2,-2.997999906539917,-0.08399999886751175,1.9989999532699585,-2.999000072479248,-0.041999999433755875,-2,-2.997999906539917,-0.08399999886751175,-2,-2.996000051498413,0.08799999952316284,-3.999000072479248,1,2,-2,-0.9990000128746033,-2.0420000553131104,-3.999000072479248,1,2,-0.9990000128746033,2,-0.9990000128746033,1.9989999532699585,-1.9980000257492065,-1.0839999914169312,1,0.9990000128746033,-2,4,1.9989999532699585,0.9990000128746033,4,1.9989999532699585,0.9990000128746033,1.9989999532699585,-2.992000102996826,0.17599999904632568,1.9989999532699585,-2.999000072479248,-0.041999999433755875,1.9989999532699585,-2.992000102996826,0.17599999904632568,0.9990000128746033,-0.9959999918937683,2.0880000591278076,-1,-1.9919999837875366,1.1759999990463257,-1,-1.9919999837875366,1.1759999990463257,-2,-2.996000051498413,0.08799999952316284,1.9989999532699585,-2.992000102996826,0.17599999904632568,-2,-2.996000051498413,0.08799999952316284,-1,-1.9919999837875366,1.1759999990463257,-3.999000072479248,1,2,4,1.9989999532699585,0.9990000128746033,0.9990000128746033,-0.9959999918937683,2.0880000591278076,1.9989999532699585,-2.992000102996826,0.17599999904632568,1.9989999532699585,-1.9980000257492065,-1.0839999914169312,1.9989999532699585,-2.999000072479248,-0.041999999433755875,-2,-2.997999906539917,-0.08399999886751175,-2,-2.997999906539917,-0.08399999886751175,-2,-0.9990000128746033,-2.0420000553131104,1.9989999532699585,-1.9980000257492065,-1.0839999914169312,-2,-0.9990000128746033,-2.0420000553131104,-2,-2.997999906539917,-0.08399999886751175,-3.999000072479248,1,2,1.9989999532699585,-1.9980000257492065,-1.0839999914169312,4,1.9989999532699585,0.9990000128746033,1.9989999532699585,-2.999000072479248,-0.041999999433755875]);
        var vertices = new Float32Array([300.2571105957031,-270.2820129394531,429.4999084472656,300.2571105957031,282.7179870605469,429.4999084472656,-299.7428894042969,282.7179870605469,430.4999084472656,-299.7428894042969,282.7179870605469,430.4999084472656,-299.7428894042969,-270.2820129394531,430.4999084472656,300.2571105957031,-270.2820129394531,429.4999084472656,300.2571105957031,282.7179870605469,-429.5000915527344,300.2571105957031,-277.2820129394531,-429.5000915527344,-299.7428894042969,-277.2820129394531,-429.5000915527344,-299.7428894042969,-277.2820129394531,-429.5000915527344,-299.7428894042969,282.7179870605469,-429.5000915527344,300.2571105957031,282.7179870605469,-429.5000915527344,300.2571105957031,282.7179870605469,429.4999084472656,300.2571105957031,282.7179870605469,-429.5000915527344,-299.7428894042969,282.7179870605469,-429.5000915527344,-299.7428894042969,282.7179870605469,-429.5000915527344,-299.7428894042969,282.7179870605469,430.4999084472656,300.2571105957031,282.7179870605469,429.4999084472656,300.2571105957031,-282.2820129394531,-294.5000915527344,300.2571105957031,-282.2820129394531,290.4999084472656,-299.7428894042969,-282.2820129394531,290.4999084472656,-299.7428894042969,-282.2820129394531,290.4999084472656,-299.7428894042969,-282.2820129394531,-294.5000915527344,300.2571105957031,-282.2820129394531,-294.5000915527344,-299.7428894042969,-282.2820129394531,-294.5000915527344,-299.7428894042969,-282.2820129394531,290.4999084472656,-299.7428894042969,282.7179870605469,430.4999084472656,-299.7428894042969,-277.2820129394531,-429.5000915527344,-299.7428894042969,282.7179870605469,430.4999084472656,-299.7428894042969,282.7179870605469,-429.5000915527344,300.2571105957031,-277.2820129394531,-429.5000915527344,300.2571105957031,282.7179870605469,-429.5000915527344,300.2571105957031,282.7179870605469,429.4999084472656,300.2571105957031,282.7179870605469,429.4999084472656,300.2571105957031,-282.2820129394531,290.4999084472656,300.2571105957031,-282.2820129394531,-294.5000915527344,300.2571105957031,-282.2820129394531,290.4999084472656,300.2571105957031,-270.2820129394531,429.4999084472656,-299.7428894042969,-270.2820129394531,430.4999084472656,-299.7428894042969,-270.2820129394531,430.4999084472656,-299.7428894042969,-282.2820129394531,290.4999084472656,300.2571105957031,-282.2820129394531,290.4999084472656,-299.7428894042969,-282.2820129394531,290.4999084472656,-299.7428894042969,-270.2820129394531,430.4999084472656,-299.7428894042969,282.7179870605469,430.4999084472656,300.2571105957031,282.7179870605469,429.4999084472656,300.2571105957031,-270.2820129394531,429.4999084472656,300.2571105957031,-282.2820129394531,290.4999084472656,300.2571105957031,-277.2820129394531,-429.5000915527344,300.2571105957031,-282.2820129394531,-294.5000915527344,-299.7428894042969,-282.2820129394531,-294.5000915527344,-299.7428894042969,-282.2820129394531,-294.5000915527344,-299.7428894042969,-277.2820129394531,-429.5000915527344,300.2571105957031,-277.2820129394531,-429.5000915527344,-299.7428894042969,-277.2820129394531,-429.5000915527344,-299.7428894042969,-282.2820129394531,-294.5000915527344,-299.7428894042969,282.7179870605469,430.4999084472656,300.2571105957031,-277.2820129394531,-429.5000915527344,300.2571105957031,282.7179870605469,429.4999084472656,300.2571105957031,-282.2820129394531,-294.5000915527344]);

        geometry.addAttribute("uv", new THREE.BufferAttribute(textures, 2, false));
        geometry.addAttribute("normal", new THREE.BufferAttribute(normals, 3, false));
        geometry.addAttribute("position", new THREE.BufferAttribute(vertices, 3, false));

        // geometry.addGroup(0, 18, 0);
        // geometry.addGroup(18, 18, 0);
        // geometry.addGroup(36, 24, 0);
        // geometry.computeBoundingBox();
 
		// 定义材质
        // meshMaterial = [
			// createMaterial('#vertex-shader', '#fragment-shader-1') // 右
			// ,createMaterial('#vertex-shader', '#fragment-shader-2') // 左
			// ,createMaterial('#vertex-shader', '#fragment-shader-3') // 上
			// ,createMaterial('#vertex-shader', '#fragment-shader-4') // 下
			// ,createMaterial('#vertex-shader', '#fragment-shader-5') // 前
			// ,createMaterial('#vertex-shader', '#fragment-shader-7') // 后
		// ]
		// meshMaterial = new THREE.MeshBasicMaterial( { color: 0x00ff00, wireframe: true } );

		var textureLoader = new THREE.TextureLoader();
		textureLoader.load("test.jpeg", function(texture) {
			meshMaterial = createMaterial('#vertex-shader', '#fragment-shader-1', texture);

			// 定义网格
	        cube = new THREE.Mesh(geometry, meshMaterial);
	        scene.add(cube);
	        renderScene();
		}, undefined, function(error) {
			console.error("load error");
		});
		
		// 定义网格
        // cube = new THREE.Mesh(geometry, meshMaterial);
        // scene.add(cube);
		
		/** 用来保存那些需要修改的变量 */
		guiParams = new function() {
			this.rotationSpeed = 0.02;
			this.vertexControl = false;
		}
		/** 定义 dat.GUI 对象，并绑定 guiParams 的几个属性 */
		var gui = new dat.GUI();
		gui.add(guiParams, 'vertexControl');
		
		renderScene();
    });
	
	/** 渲染场景 */
	function renderScene() {
		// stats.update();
		// rotateMesh(); // 旋转物体
		// changeVertex();
		
		requestAnimationFrame(renderScene);
		render.render(scene, camera);
	}
	
	/** 初始化 stats 统计对象 */
	function initStats() {
		stats = new Stats();
		stats.setMode(0); // 0 为监测 FPS；1 为监测渲染时间
		$('#stats-output').append(stats.domElement);
		return stats;
	}
	
	/** 当浏览器窗口大小变化时触发 */
	function onWindowResize() {
		camera.aspect = window.innerWidth / window.innerHeight;
		camera.updateProjectionMatrix();
		render.setSize(window.innerWidth, window.innerHeight);
	}
	
	/** 旋转物体 */
	function rotateMesh() {
		scene.traverse(function(mesh) {
			if (mesh instanceof THREE.Mesh && mesh != ground) {
				mesh.rotation.x += guiParams.rotationSpeed;
				mesh.rotation.y += guiParams.rotationSpeed;
				mesh.rotation.z += guiParams.rotationSpeed;
			}
		});
	}
	
	/** 变换方块的每一个顶点 */
	function changeVertex() {
		if (!guiParams.vertexControl) return;
		cube.material.forEach(function (e) {
			e.uniforms.time.value += 0.01;
		});
	}
	
	/** 自定义创建 ShaderMaterial 材质 */
	function createMaterial(vertexShader, fragmentShader, texture) {
		var vertShader = $(vertexShader).text();
		var fragShader = $(fragmentShader).text();
		
		// var uniforms = {
		// 	time: {type: 'f', value: 0.2},
		// 	scale: {type: 'f', value: 0.2},
		// 	alpha: {type: 'f', value: 0.6},
		// 	resolution: {type: 'v2', value: new THREE.Vector2()}
		// };


		
		// uniforms.resolution.value.x = window.innerWidth;
		// uniforms.resolution.value.y = window.innerHeight;
		
		var uniforms = {
			uvMatrix: {
                value: null//{element:[1, -0, 0, 0, 1, 0,0,0,1]}
            },
            vertexConstant: {
                value: new THREE.Vector3(-299.7428894042969, -282.2820129394531, -429.5000915527344)
            },
            vertexParameters: {
                value: new THREE.Vector2(1, 1)
            }
		}
		uniforms = THREE.UniformsUtils.merge( [uniforms, THREE.UniformsLib['common'],THREE.UniformsLib['lights']] );

		shaderMaterial = new THREE.ShaderMaterial({
			uniforms: uniforms,
			map: texture,
			vertexShader: vertShader,
			fragmentShader: fragShader,
			transparent: true,
			defines: {
		        USE_UV_MATRIX: "",
		        USE_MAP: true
		    }
		});
		// shaderMaterial.uniforms.map.value = texture
		// shaderMaterial.map = texture
		
		return shaderMaterial;
	}
 
</script>
</body>
</html>
